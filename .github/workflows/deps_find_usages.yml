name: Deps – Find Usages

on:
  issue_comment:
    types: [created]

jobs:
  find-usages:
    if: github.event.issue.pull_request != null &&
        contains(github.event.comment.body, '/deps-find-usages')

    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    env:
      GEM_REVIEW_PATH: gem_review.md
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

    steps:
      - name: Show triggering comment
        run: |
          echo "Comment body:"
          echo "${{ github.event.comment.body }}"
          echo "On PR: #${{ github.event.issue.number }}"

      - name: Get PR branch name
        id: pr-info
        run: |
          # Get PR details using GitHub API
          PR_DATA=$(curl -s -H "Authorization: token ${{ github.token }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.issue.number }}")
          
          BRANCH_NAME=$(echo "$PR_DATA" | jq -r '.head.ref')
          REPO_FULL_NAME=$(echo "$PR_DATA" | jq -r '.head.repo.full_name')
          
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "repo=$REPO_FULL_NAME" >> $GITHUB_OUTPUT
          echo "✓ Branch: $BRANCH_NAME from $REPO_FULL_NAME"

      - name: Check out PR branch
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.pr-info.outputs.repo }}
          ref: ${{ steps.pr-info.outputs.branch }}
          token: ${{ github.token }}
          fetch-depth: 0

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3.0'
          bundler-cache: false

      - name: Ensure gem_review.md exists (re-run gem_diff)
        run: ruby .github/scripts/gem_diff.rb

      - name: Run deps usage finder
        run: ruby .github/scripts/deps_find_usages.rb

      - name: Run LLM suggestions (Gemini)
        run: ruby .github/scripts/deps_llm_suggestions.rb

      - name: Format Gemini suggestions into changelog
        run: ruby .github/scripts/format_changelog_entry.rb

      - name: Check if gemini_suggestions.md exists
        id: check_suggestions
        run: |
          if [ -f "gemini_suggestions.md" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "⚠️ gemini_suggestions.md not found - skipping suggestion organization and comment"
          fi

      - name: Organize suggestions by gem
        if: steps.check_suggestions.outputs.exists == 'true'
        run: ruby .github/scripts/organize_suggestions.rb

      - name: Auto-apply code suggestions
        if: steps.check_suggestions.outputs.exists == 'true'
        run: ruby .github/scripts/auto_apply_suggestions.rb

      - name: Post Gemini suggestions as PR comment
        if: steps.check_suggestions.outputs.exists == 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ github.token }}
          issue-number: ${{ github.event.issue.number }}
          body-file: gemini_suggestions.md
          
      - name: Commit and push changes (if any)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          
          if git diff --cached --quiet; then
            echo "✓ No changes to commit."
            exit 0
          fi
          
          git commit -m "chore(deps): Add TODO comments and Gemini suggestions for upgraded gems

          - Updated TODO comments for changed gem dependencies
          - Added LLM suggestions for version-specific code updates
          - Auto-applied code changes from AI suggestions where possible
          - See gemini_suggestions.md for detailed upgrade guidance"
          
          echo "✓ Changes committed. Pushing to branch: ${{ steps.pr-info.outputs.branch }}"
          
          # Push to the PR branch
          if git push origin HEAD:${{ steps.pr-info.outputs.branch }}; then
            echo "✓ Successfully pushed changes to PR branch"
          else
            echo "❌ Failed to push changes. This may be a fork or permission issue."
            echo "Changes are committed but not pushed. Please manually push or check permissions."
            exit 1
          fi